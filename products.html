<?php
session_start();

// Проверка авторизации
if (!isset($_SESSION['user_id'])) {
    header('Location: login.html');
    exit();
}

// Подключение к базе данных
$host = 'localhost';
$dbname = 'weddingsalondb';
$username = 'root';
$password = '';

try {
    $pdo = new PDO("mysql:host=$host;dbname=$dbname;charset=utf8", $username, $password);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
} catch(PDOException $e) {
    die("Ошибка подключения к базе данных: " . $e->getMessage());
}

// Обработка добавления нового продукта
$error = '';
$success = '';

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['add_product'])) {
    $productName = trim($_POST['product_name'] ?? '');
    $category = trim($_POST['category'] ?? '');
    $size = trim($_POST['size'] ?? '');
    $color = trim($_POST['color'] ?? '');
    $price = trim($_POST['price'] ?? '');
    $purchasePrice = trim($_POST['purchase_price'] ?? '');
    $quantity = trim($_POST['quantity'] ?? '');
    $vendor = trim($_POST['vendor'] ?? '');
    $description = trim($_POST['description'] ?? '');
    $isAvailable = isset($_POST['is_available']) ? 1 : 0;

    // Валидация
    if (empty($productName) || empty($category) || empty($price) || empty($quantity)) {
        $error = 'Название, категория, цена и количество обязательны для заполнения';
    } elseif (!is_numeric($price) || $price <= 0) {
        $error = 'Цена должна быть положительным числом';
    } elseif (!is_numeric($purchasePrice) || $purchasePrice < 0) {
        $error = 'Закупочная цена должна быть положительным числом или нулем';
    } elseif (!is_numeric($quantity) || $quantity < 0) {
        $error = 'Количество должно быть неотрицательным числом';
    } else {
        try {
            $stmt = $pdo->prepare("INSERT INTO products (ProductName, Category, Size, Color, Price, PurchasePrice, Quantity, Vendor, Description, IsAvailable)
                                  VALUES (:product_name, :category, :size, :color, :price, :purchase_price, :quantity, :vendor, :description, :is_available)");

            $stmt->execute([
                ':product_name' => $productName,
                ':category' => $category,
                ':size' => $size ?: null,
                ':color' => $color ?: null,
                ':price' => $price,
                ':purchase_price' => $purchasePrice ?: 0,
                ':quantity' => $quantity,
                ':vendor' => $vendor ?: null,
                ':description' => $description ?: null,
                ':is_available' => $isAvailable
            ]);

            $success = 'Продукт успешно добавлен!';

            // Очищаем поля формы
            $_POST = [];

        } catch(PDOException $e) {
            $error = 'Ошибка при добавлении продукта: ' . $e->getMessage();
        }
    }
}

// Получение списка продуктов
$products = [];
try {
    $stmt = $pdo->query("SELECT * FROM products ORDER BY ProductID DESC");
    $products = $stmt->fetchAll(PDO::FETCH_ASSOC);
} catch(PDOException $e) {
    $error = 'Ошибка при загрузке списка продуктов: ' . $e->getMessage();
}
?>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Продукты - Свадебный салон</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #ffe6f2;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .header {
            background-color: #ff66b2;
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            margin: 0;
            font-size: 28px;
        }

        .nav-links {
            text-align: center;
            margin-bottom: 20px;
        }

        .nav-link {
            display: inline-block;
            margin: 0 10px;
            padding: 8px 15px;
            background-color: #ffccdd;
            color: #333;
            text-decoration: none;
            border-radius: 5px;
        }

        .nav-link:hover {
            background-color: #ff99cc;
        }

        .section {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .section-title {
            color: #ff3399;
            margin-top: 0;
            border-bottom: 2px solid #ffccdd;
            padding-bottom: 10px;
        }

        .message {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .error {
            background-color: #ffcccc;
            color: #cc0000;
            border: 1px solid #ff9999;
        }

        .success {
            background-color: #ccffcc;
            color: #006600;
            border: 1px solid #99ff99;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ff99cc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        textarea {
            resize: vertical;
            height: 80px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="checkbox"] {
            width: auto;
            transform: scale(1.2);
        }

        .submit-btn {
            background-color: #ff66b2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .submit-btn:hover {
            background-color: #ff3399;
        }

        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .products-table th,
        .products-table td {
            border: 1px solid #ff99cc;
            padding: 10px;
            text-align: left;
        }

        .products-table th {
            background-color: #ffccdd;
            color: #333;
            font-weight: bold;
        }

        .products-table tr:nth-child(even) {
            background-color: #fff5f9;
        }

        .products-table tr:hover {
            background-color: #ffe6f2;
        }

        .price {
            text-align: right;
        }

        .available-yes {
            color: #006600;
            font-weight: bold;
        }

        .available-no {
            color: #cc0000;
            font-weight: bold;
        }

        .required {
            color: #ff0000;
        }

        .category-dress {
            background-color: #ffe6ff;
        }

        .category-suit {
            background-color: #e6f2ff;
        }

        @media (max-width: 768px) {
            .products-table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Управление продуктами</h1>
    </div>

    <div class="nav-links">
        <a href="workplace.html" class="nav-link">← Назад в рабочее место</a>
        <a href="index.html" class="nav-link">На главную</a>
        <a href="logout.html" class="nav-link">Выйти</a>
    </div>

    <!-- Форма добавления продукта -->
    <div class="section">
        <h2 class="section-title">Добавить новый продукт</h2>

        <?php if ($error): ?>
            <div class="message error"><?php echo htmlspecialchars($error); ?></div>
        <?php endif; ?>

        <?php if ($success): ?>
            <div class="message success"><?php echo htmlspecialchars($success); ?></div>
        <?php endif; ?>

        <form method="POST" action="">
            <div class="form-group">
                <label for="product_name">Название продукта <span class="required">*</span></label>
                <input type="text" id="product_name" name="product_name" required
                       value="<?php echo htmlspecialchars($_POST['product_name'] ?? ''); ?>">
            </div>

            <div class="form-group">
                <label for="category">Категория <span class="required">*</span></label>
                <select id="category" name="category" required>
                    <option value="">Выберите категорию</option>
                    <option value="Платье" <?php echo (isset($_POST['category']) && $_POST['category'] == 'Платье') ? 'selected' : ''; ?>>Платье</option>
                    <option value="Костюм" <?php echo (isset($_POST['category']) && $_POST['category'] == 'Костюм') ? 'selected' : ''; ?>>Костюм</option>
                    <option value="Аксессуар" <?php echo (isset($_POST['category']) && $_POST['category'] == 'Аксессуар') ? 'selected' : ''; ?>>Аксессуар</option>
                    <option value="Обувь" <?php echo (isset($_POST['category']) && $_POST['category'] == 'Обувь') ? 'selected' : ''; ?>>Обувь</option>
                    <option value="Другое" <?php echo (isset($_POST['category']) && $_POST['category'] == 'Другое') ? 'selected' : ''; ?>>Другое</option>
                </select>
            </div>

            <div class="form-group">
                <label for="size">Размер</label>
                <input type="text" id="size" name="size"
                       value="<?php echo htmlspecialchars($_POST['size'] ?? ''); ?>">
            </div>

            <div class="form-group">
                <label for="color">Цвет</label>
                <input type="text" id="color" name="color"
                       value="<?php echo htmlspecialchars($_POST['color'] ?? ''); ?>">
            </div>

            <div class="form-group">
                <label for="price">Цена продажи (руб.) <span class="required">*</span></label>
                <input type="number" id="price" name="price" required min="0" step="1000"
                       value="<?php echo htmlspecialchars($_POST['price'] ?? ''); ?>">
            </div>

            <div class="form-group">
                <label for="purchase_price">Закупочная цена (руб.)</label>
                <input type="number" id="purchase_price" name="purchase_price" min="0" step="1000"
                       value="<?php echo htmlspecialchars($_POST['purchase_price'] ?? ''); ?>">
            </div>

            <div class="form-group">
                <label for="quantity">Количество <span class="required">*</span></label>
                <input type="number" id="quantity" name="quantity" required min="0"
                       value="<?php echo htmlspecialchars($_POST['quantity'] ?? '1'); ?>">
            </div>

            <div class="form-group">
                <label for="vendor">Поставщик</label>
                <input type="text" id="vendor" name="vendor"
                       value="<?php echo htmlspecialchars($_POST['vendor'] ?? ''); ?>">
            </div>

            <div class="form-group">
                <label for="description">Описание</label>
                <textarea id="description" name="description"><?php echo htmlspecialchars($_POST['description'] ?? ''); ?></textarea>
            </div>

            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="is_available" name="is_available" value="1"
                           <?php echo (isset($_POST['is_available']) || !isset($_POST['add_product'])) ? 'checked' : ''; ?>>
                    <label for="is_available">Доступен для продажи</label>
                </div>
            </div>

            <button type="submit" name="add_product" class="submit-btn">Добавить продукт</button>
        </form>
    </div>

    <!-- Список продуктов -->
    <div class="section">
        <h2 class="section-title">Список продуктов</h2>

        <?php if (empty($products)): ?>
            <p>Продуктов пока нет.</p>
        <?php else: ?>
            <table class="products-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Название</th>
                        <th>Категория</th>
                        <th>Размер</th>
                        <th>Цвет</th>
                        <th>Цена</th>
                        <th>Закупка</th>
                        <th>Кол-во</th>
                        <th>Поставщик</th>
                        <th>Описание</th>
                        <th>Доступен</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($products as $product): ?>
                    <tr class="<?php echo ($product['Category'] == 'Платье') ? 'category-dress' : (($product['Category'] == 'Костюм') ? 'category-suit' : ''); ?>">
                        <td><?php echo htmlspecialchars($product['ProductID']); ?></td>
                        <td><?php echo htmlspecialchars($product['ProductName']); ?></td>
                        <td><?php echo htmlspecialchars($product['Category']); ?></td>
                        <td><?php echo htmlspecialchars($product['Size'] ?? '-'); ?></td>
                        <td><?php echo htmlspecialchars($product['Color'] ?? '-'); ?></td>
                        <td class="price"><?php echo number_format($product['Price'], 0, '', ' ') . ' руб.'; ?></td>
                        <td class="price"><?php echo number_format($product['PurchasePrice'], 0, '', ' ') . ' руб.'; ?></td>
                        <td><?php echo htmlspecialchars($product['Quantity']); ?></td>
                        <td><?php echo htmlspecialchars($product['Vendor'] ?? '-'); ?></td>
                        <td><?php echo htmlspecialchars($product['Description'] ?? '-'); ?></td>
                        <td class="<?php echo $product['IsAvailable'] ? 'available-yes' : 'available-no'; ?>">
                            <?php echo $product['IsAvailable'] ? 'Да' : 'Нет'; ?>
                        </td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        <?php endif; ?>
    </div>

    <div class="nav-links">
        <a href="workplace.html" class="nav-link">← Назад в рабочее место</a>
    </div>
</body>
</html>
